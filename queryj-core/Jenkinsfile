pipeline {
    agent any

    tools {
        maven 'maven' // Ensure Jenkins uses the right Maven installation
    }

    options {
        skipDefaultCheckout() // Avoids Jenkins auto-checkout
    }

    environment {
        GIT_REPO = 'git@github.com:rydnr/java-commons.git' // Your repository URL
        CREDENTIALS_ID = 'github' // Jenkins credentials ID for SSH key
        GROUP_ID = 'org.acmsl.queryj'
        ARTIFACT_ID = 'queryj-core'
        MAVEN_REPO = 'http://maven.acm-sl.org/repository/maven-snapshots-local'
        LOCAL_VERSION_FILE = "${WORKSPACE}/.last_snapshot_versions"
        MAVEN_OPTS = "-Dmaven.repo.local=${WORKSPACE}/.m2/repository" // Optional: Isolate repo per build
    }

    stages {
        stage('Checkout') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/main']], // Replace with your branch
                    doGenerateSubmoduleConfigurations: false,
                    extensions: [
                        [$class: 'WipeWorkspace'], // Wipes workspace before cloning
                        [$class: 'CloneOption', depth: 0, noTags: false, reference: '', shallow: false]
                    ],
                    submoduleCfg: [],
                    userRemoteConfigs: [[
                        url: env.GIT_REPO,
                        credentialsId: env.CREDENTIALS_ID
                    ]]
                ])
            }
        }

        stage('Build and Deploy') {
            when {
                expression { currentBuild.result == 'SUCCESS' }
            }
            steps {
                withMaven(maven: 'Maven') {  // Enables Jenkins to track SNAPSHOT dependencies
                    sh '/home/jenkins/.sdkman/candidates/maven/current/bin/mvn clean deploy'
                }
            }
        }
    }
}
